# Quantum Design DAT Tool – C# 重构开发文档

## 1. 项目概述
- **目标**：使用 C#/.NET 8 重构现有 Python 版 DAT 数据可视化工具，保持核心功能并提升可维护性、性能和用户体验。
- **成果**：交付一款 Windows 桌面应用（后续可扩展跨平台），具备安装包、测试用例和完整文档。
- **范围**：数据解析、筛选逻辑、绘图展示、国际化、打包发布等全栈重构。

## 2. 技术栈与解决方案结构
- **运行时**：.NET 8 + C#
- **UI 框架**：WPF（后续可考虑 WinUI 3 或 Avalonia）
- **绘图**：OxyPlot.Wpf（备选 LiveCharts2、ScottPlot）
- **数据处理**：LINQ、MathNet.Numerics（可选）
- **架构模式**：MVVM，使用 CommunityToolkit.Mvvm 简化命令与通知
- **依赖注入**：Microsoft.Extensions.DependencyInjection
- **日志**：Serilog
- **测试**：xUnit + FluentAssertions

解决方案建议结构：
```
DatTool.Domain       // 数据模型、常量
DatTool.Services     // 解析、类型识别、筛选、导出
DatTool.ViewModels   // MVVM 层
DatTool.UI           // WPF 前端
DatTool.Tests        // 单元 & 集成测试
docs/                // 文档
```

## 3. 功能点清单
### 3.1 文件管理
- 打开 `.dat`（文件对话框 / 拖拽）并记忆最近路径
- 自动编码检测（BOM + 备选编码提示）
- 文件信息面板：名称、路径、大小、修改时间、行数、测量类型
- 最近文件列表（可配置数量）

### 3.2 DAT 解析与类型识别
- 支持含注释/空列的 DAT 文件
- 自动识别测量类型（比热/磁学/电阻），允许手动覆盖
- 为不同类型绑定默认 X/Y 轴、筛选列、容差、连续行参数
- 统一数据模型 `MeasurementSet`、`DataSegment`

### 3.3 数据筛选与处理
- 筛选面板：列下拉、均值输入、容差、最小连续行
- 自动推荐参数（根据测量类型）
- 筛选结果列表：段编号、行范围、均值、类型标签
- 时间列转换开关（字符串 ↔ DateTime）
- 导出筛选摘要（用于测试/分享）

### 3.4 数据段列表与选择
- Tree/List 视图展示段信息
- 选择模式：单击、Shift 范围、Ctrl 累积；支持取消
- 右键操作：查看详情、导出段 CSV、添加备注
- 叠加上限提示（默认 8 个段）

### 3.5 绘图
- 绘图类型：折线、散点、折线+散点
- 多段叠加，颜色循环、图例可控
- 坐标轴标题、单位根据测量类型自动设置并可调整
- 缩放：矩形缩放、双击重置、缩放历史栈（后退/前进）
- 数据提示（Data Tooltip）显示点值与段名
- 可选平移、中键拖拽

### 3.6 状态与日志
- 状态栏反馈：就绪、加载中、处理中、绘图完成、缩放状态等
- 进度条/旋转指示器处理大文件
- 错误提示：格式异常、列缺失、筛选为空、叠加超限
- 日志文件按日期输出，便于问题排查

### 3.7 国际化与外观
- 自动检测系统语言（中/英），设置里可切换，实时生效
- 所有文本采用 `.resx` 管理，保持 Python 版文案一致
- 支持高 DPI：启动时设置 DPI 感知，动态字体缩放
- UI 主题：默认浅色，可扩展高对比模式

### 3.8 设置与持久化
- 用户偏好：窗口尺寸、语言、最近文件、默认筛选参数、绘图类型
- 配置文件：`appsettings.json` 或用户配置目录
- 设置界面管理时间转换开关、日志等级、导出路径

### 3.9 导出与分享
- 导出当前图像为 PNG/SVG（可设置 DPI）
- 导出筛选结果或单个段为 CSV/JSON
- 复制图表到剪贴板（可选）

### 3.10 测试与诊断
- 内置诊断信息视图：版本、依赖、DPI、当前语言
- 回放示例数据（测试模式）以便验证 UI
- 日志/诊断打包功能，便于用户反馈

## 4. 里程碑与进度
| 里程碑 | 时间 | 交付内容 |
|--------|------|-----------|
| M1 架构 & 需求 | 第 1 周 | Python 功能清单、测试数据集、架构图、本文档 |
| M2 数据层完成 | 第 2-3 周 | DAT 解析、筛选服务、单元测试、与 Python 输出对照 |
| M3 MVVM & UI | 第 4-5 周 | WPF 界面、绘图集成、交互细节、基础国际化 |
| M4 联调 & 调优 | 第 6 周 | 功能验收、性能优化、Bug 修复、文档更新 |
| M5 发布准备 | 第 7 周 | 打包脚本、安装包、发布说明、已知问题列表 |

## 5. 验证策略
- 单元测试覆盖解析、筛选、类型识别逻辑（对照 Python 导出的 CSV）
- 集成测试：加载真实 DAT 样例，验证绘图数据与统计信息
- 手工 UI 测试用例：多语言、缩放、叠加、错误提示
- 自动化 UI（可选）：WinAppDriver/Playwright for Windows
- 性能测试：大文件加载时间、交互响应、内存占用

## 6. 风险与应对
- **绘图库差异**：先做 PoC 评估 OxyPlot；如不满足需求，考虑 ScottPlot/LiveCharts
- **大型文件性能**：实现流式解析、Lazy 数据绑定，下采样绘图
- **国际化一致性**：建立 resx key 校验脚本，防止中英文不匹配
- **跨平台需求变动**：业务逻辑与 UI 解耦，后续可复用到 Avalonia/MAUI

## 7. 参考资料
- Python 原项目 README、源代码
- Quantum Design DAT 格式手册
- .NET 高 DPI 指南、WPF 国际化实践
- OxyPlot / LiveCharts 官方文档

## 8. 任务分解与优先级
| 阶段 | 优先级 | 任务 | 说明 |
|------|--------|------|------|
| M1 | 高 | 采集 Python 行为清单 | 记录输入输出、交互细节、测试数据 |
| M1 | 高 | 建立 .NET 解决方案骨架 | 创建解决方案 + Domain/Services/ViewModels/UI/Tests 项目 |
| M1 | 中 | 搭建 CI/构建脚本雏形 | dotnet format、单测、发布脚本 |
| M2 | 高 | DAT 解析器实现 | 包含编码检测、列映射、异常处理 |
| M2 | 高 | 测量类型识别服务 | 规则表、默认参数生成 |
| M2 | 高 | 筛选与段生成服务 | 容差算法、连续行逻辑、时间转换 |
| M2 | 中 | 导出/日志基础设施 | CSV/JSON 导出、Serilog 配置 |
| M3 | 高 | MVVM 层实现 | MainViewModel、命令、状态管理 |
| M3 | 高 | 绘图组件集成 | OxyPlot Host、叠加/颜色/缩放逻辑 |
| M3 | 中 | 多语言与设置 | resx 绑定、配置持久化 |
| M4 | 高 | 端到端联调与性能优化 | 大文件测试、内存分析、UI 调优 |
| M5 | 高 | 发布与文档交付 | 自包含发布、安装包、用户指南 |

**待办队列（可拆成 issue）**
- 编码检测/回退策略设计
- DAT 示例集整理与自动化对比
- 颜色主题与高对比模式设计
- WinAppDriver 自动化验证脚本
- 安装包签名方案评估

---
此文档用于跟踪开发进度、核对功能覆盖以及团队协作。后续变更请在 PR 中同步更新。

